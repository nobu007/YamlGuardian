name: CI Auto Merge

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
  check_suite:
    types: [completed]
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
    - name: Check PR status
      uses: actions/github-script@v3
      with:
        script: |
          const pr = await github.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.inputs ? context.payload.inputs.pr_number : context.payload.pull_request.number,
          });
          if (pr.data.state !== 'open' || pr.data.mergeable_state !== 'clean') {
            core.setFailed('PR is not in a mergeable state');
          }

    - name: Auto merge
      uses: peter-evans/merge@v2
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        merge-method: squash
        commit-message: "CI auto-merge"
