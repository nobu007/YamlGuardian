# ARCHITECTURE.md (日本語版)

## 1. 概要

このドキュメントは、YamlGuardian プロジェクトのアーキテクチャについて概説します。明確な責務の分離とモジュール化された設計に焦点を当てています。このシステムは、定義済みのルールとスキーマに基づいて YAML データを検証するように設計されています。このアーキテクチャは、テスト容易性、保守性、および拡張性を優先します。

## 2. システムアーキテクチャ

このアーキテクチャは、修正されたクリーンアーキテクチャに基づいており、責務の分離と依存性逆転を強調するために、ヘキサゴナルアーキテクチャの要素を取り入れています。

```plaintext
YamlGuardian
├── Orchestration # システム全体のオーケストレーション層
├── Validation # 検証機能
│ ├── Schema # スキーマ定義の管理
│ │ ├── common # スキーマの共通処理、I/O に依存しない
│ │ ├── prepare # スキーマのロード、パース、事前検証
│ │ ├── logic # スキーマの検証、操作
│ │ └── postprocess # スキーマの後処理、キャッシュ、変換
│ ├── Rule # 検証ルール管理
│ │ ├── common # ルールの共通処理、I/O に依存しない
│ │ ├── prepare # ルールのロード、パース、事前検証
│ │ ├── logic # ルールの検証、適用
│ │ └── postprocess # ルールの後処理、キャッシュ
│ ├── Data # 検証対象データ管理
│ │ ├── common # データの共通処理、I/O に依存しない
│ │ ├── prepare # データのロード、変換
│ │ ├── logic # スキーマとルールに基づくデータ検証
│ │ └── postprocess # データの後処理、エラーメッセージ生成
├── Presentation # 外部インターフェース (CLI、API、プレゼンター)
│ ├── Input # 入力処理
│ │ ├── common # 入力データの共通処理
│ │ ├── prepare # 入力データの受付、パース
│ │ ├── logic # 入力データの検証、変換
│ │ └── postprocess # 検証済みデータの UseCase への受け渡し
│ ├── Output # 出力処理
│ │ ├── common # 出力データの共通処理
│ │ ├── prepare # 出力データの整形
│ │ ├── logic # 出力データの検証、変換
│ │ └── postprocess # 出力処理
├── Commons # 共通コンポーネント
│ ├── CrossCutting# ロギング、セキュリティ、例外処理
│ ├── Utilities # 汎用的なユーティリティクラス
├── Infrastructure
│ ├── FrameworkAdapter # フレームワーク固有の処理の抽象化
│ └── ExternalAdapter # 外部サービス連携の抽象化
```

## 3. モジュールの責務

### 3.1 オーケストレーション (Orchestration)

- 検証プロセス全体のオーケストレーションを担当し、さまざまなコンポーネント間のインタラクションを調整します。
- クライアントに単一のエントリポイントを提供するファサードとして機能します。

### 3.2 検証 (Validation)

このパッケージには、データの検証に関連するすべての機能が含まれています。

- **Schema**:
  - スキーマ定義を管理します。
  - `common`: スキーマのロードおよび保存を処理します (I/O 非依存)。
  - `prepare`: YAML スキーマファイルを解析し、事前検証を実行します。
  - `logic`: スキーマ構造を検証および操作します。
  - `postprocess`: スキーマを他の形式 (例: JSON Schema) に変換し、キャッシュに保存します。
- **Rule**:
  - 検証ルールを管理します。
  - `common`: ルールのロードおよび保存を処理します (I/O 非依存)。
  - `prepare`: YAML ルールファイルを解析し、事前検証を実行します。
  - `logic`: ルールを適用および検証します。
  - `postprocess`: 検証済みのルールをキャッシュに保存します。
- **Data**:
  - 検証対象のデータを管理します。
  - `common`: データの共通操作 (I/O 非依存) を処理します。
  - `prepare`: データをロードおよび変換します。
  - `logic`: スキーマとルールに基づいてデータを検証します。
  - `postprocess`: エラーメッセージやその他の検証関連タスクを生成します。

### 3.3 プレゼンテーション (Presentation)

CLI、API、プレゼンテーションロジックなどの外部インターフェースを処理します。

- **Input**:
  - `common`: 受信データの一般的な処理を扱います。
  - `prepare`: 外部ソースからの入力を解析します。
  - `logic`: 入力データを検証および変換します。
  - `postprocess`: 検証済みデータを UseCase に渡します。
- **Output**:
  - `common`: 一般的な出力処理。
  - `prepare`: 出力用にデータをフォーマットします。
  - `logic`: 出力前にデータを検証および変換します。
  - `postprocess`: 出力を外部インターフェースに配信します。

### 3.4 共通コンポーネント (Commons)

システム全体で共有されるコンポーネントが含まれています。

- **CrossCutting**:
  - ロギング、セキュリティ、例外処理などのクロス・カッティング・コンサーンを実装します。
- **Utilities**:
  - 文字列操作や日付フォーマットなどの汎用的なユーティリティクラスを提供します。

### 3.5 インフラストラクチャ (Infrastructure)

外部依存関係の抽象化レイヤーを提供します。

- **FrameworkAdapter**:
  - ファイルシステムアクセスや HTTP リクエストなど、フレームワーク固有の操作をラップします。
- **ExternalAdapter**:
  - データベースアクセスや API 呼び出しなどの外部サービス連携をラップします。

## 4. データフロー

1.  オーケストレーション層は、プレゼンテーション層からリクエストを受け取ります。
2.  オーケストレーション層は、検証層と連携してデータを検証します。
3.  検証層は、スキーマ、ルール、およびデータサブコンポーネントを使用して検証を実行します。
4.  インフラストラクチャ層は、ファイルシステムやデータベースなどの外部リソースへのアクセスを提供します。
5.  共通コンポーネント層は、汎用ユーティリティ関数とロギングなどのクロス・カッティング・コンサーンを提供します。
6.  オーケストレーション層は、検証結果をプレゼンテーション層に返します。
7.  プレゼンテーション層は、結果をフォーマットし、ユーザーに表示します。
